<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outils de positionnement de mes habilet√©s technologiques en FAD</title>
    <!-- Biblioth√®ques externes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-bg: #2e3192;
            --accent-color: #00a99d;
            --header-height: 230px;
            --bg-light: #f4f7f6;
            --panel-bg: #ffffff;
            --text-main: #333333;
            --question-bg: #f8f9fa;
            --border-color: #dddddd;
            
            --color-cat-0: #FF8F00; /* √âlaboration */
            --color-cat-1: #00B0FF; /* D√©marche */
            --color-cat-2: #00E676; /* Organisation */
            --color-cat-3: #D500F9; /* Encadrement */

            --color-debutant: #FF8F00;
            --color-inter: #00B0FF;
            --color-expert: #00E676;

            --card-border-danger: #e74c3c;
            --card-border-gestion: #00a99d;
            --card-border-result: #8e44ad;
        }

        .dark-mode {
            --bg-light: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --question-bg: #2d2d2d;
            --border-color: #444444;
            --accent-color: #00d1c1;
        }

        * { box-sizing: border-box; scroll-behavior: smooth; }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            background-color: var(--bg-light);
            color: var(--text-main);
            transition: background 0.3s, color 0.3s;
        }

        header {
            height: var(--header-height);
            background: linear-gradient(135deg, #1b1e5d 0%, #2e3192 100%);
            color: white;
            padding: 20px 30px;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
            box-shadow: 0 3px 15px rgba(0,0,0,0.3);
            z-index: 1000; flex-shrink: 0;
        }

        header h1 { margin: 0; font-size: 1.8rem; text-transform: uppercase; letter-spacing: 1px; text-align: center; }
        .header-profile { display: flex; align-items: center; gap: 10px; font-size: 1.1rem; margin: 5px 0; opacity: 0.9; }

        #user-name {
            background: rgba(255,255,255,0.1); border: none; border-bottom: 2px solid var(--accent-color);
            color: white; padding: 2px 10px; font-weight: bold; text-align: center; width: 220px; border-radius: 4px 4px 0 0;
        }

        .action-station { display: flex; gap: 15px; justify-content: center; width: 100%; margin-top: 10px; }

        button.action-card { 
            background: var(--panel-bg); color: var(--text-main); border: none; border-bottom: 4px solid var(--accent-color);
            padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 0.85rem; 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            display: flex; flex-direction: column; align-items: center; gap: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 110px;
        }
        .btn-card-danger { border-bottom-color: var(--card-border-danger) !important; }
        .btn-card-gestion { border-bottom-color: var(--card-border-gestion) !important; }
        .btn-card-result { border-bottom-color: var(--card-border-result) !important; }
        button.action-card:hover { transform: translateY(-8px); box-shadow: 0 12px 20px rgba(0,0,0,0.25); filter: brightness(1.05); }

        .settings-stack { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; margin-left: 10px; }
        .dark-mode-card { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: white; transition: transform 0.3s; }
        .save-indicator { cursor: help; font-size: 1rem; opacity: 0.5; }

        main { display: flex; flex: 1; height: calc(100vh - var(--header-height)); overflow: hidden; }

        #panel-questions { width: 550px; background: var(--panel-bg); border-right: 1px solid var(--border-color); overflow-y: auto; padding: 25px; flex-shrink: 0; position: relative; }

        .quick-nav { display: flex; gap: 5px; margin-bottom: 20px; position: sticky; top: -25px; background: var(--panel-bg); padding: 10px 0; z-index: 100; border-bottom: 1px solid var(--border-color); }
        .nav-btn { background: var(--question-bg); border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-weight: bold; color: var(--text-main);}

        #right-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        #panel-chart {
            height: 380px; background: var(--panel-bg); border-bottom: 1px solid var(--border-color);
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center; 
            padding: 15px; flex-shrink: 0;
            background: radial-gradient(circle at center, var(--panel-bg) 0%, var(--bg-light) 100%);
            position: relative;
        }

        .pillars-container {
            display: flex; justify-content: space-around; align-items: flex-end;
            width: 100%; max-width: 500px; height: 160px; margin: 10px 0;
            position: relative; padding: 0 20px;
        }

        .pillar-wrapper { display: flex; flex-direction: column; align-items: center; width: 60px; height: 100%; }
        .pillar-glass {
            width: 35px; height: 130px; background: rgba(0,0,0,0.05); border: 1px solid var(--border-color);
            border-radius: 5px; position: relative; overflow: hidden;
            display: flex; align-items: flex-end;
        }
        .dark-mode .pillar-glass { background: rgba(255,255,255,0.05); }
        .pillar-fill { width: 100%; height: 0%; transition: height 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275), background 0.5s; position: relative; }
        .pillar-dots { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(rgba(255,255,255,0.3) 1px, transparent 1px); background-size: 4px 4px; pointer-events: none; }
        .pillar-label { font-size: 0.65rem; font-weight: bold; margin-top: 8px; text-transform: uppercase; color: var(--primary-bg); text-align: center; }
        
        #global-avg-line {
            position: absolute; left: 45px; right: 45px; height: 2px;
            background: white; box-shadow: 0 0 10px white;
            z-index: 10; opacity: 0; transition: bottom 1s, opacity 0.5s;
            pointer-events: none;
        }
        #global-avg-line::after {
            content: 'Moyenne'; position: absolute; right: -40px; top: -7px;
            font-size: 0.5rem; font-weight: bold; color: var(--primary-bg);
            background: white; padding: 2px 4px; border-radius: 3px;
        }

        #gauge-label { font-weight: bold; font-size: 1.3rem; margin-top: 5px; text-align: center; }
        #archetype-container { margin-top: 5px; text-align: center; }
        #profile-type-badge { display: inline-block; font-size: 0.85rem; font-weight: 800; padding: 4px 14px; border-radius: 20px; background: var(--primary-bg); color: white; text-transform: uppercase; letter-spacing: 1px; }
        #profile-description { font-size: 0.75rem; margin-top: 4px; color: var(--text-main); font-style: italic; max-width: 400px; line-height: 1.2; }

        .growth-container { display: flex; gap: 30px; margin-top: 10px; }
        .growth-stage { display: flex; flex-direction: column; align-items: center; opacity: 0.2; grayscale: 100%; transition: all 0.5s; }
        .growth-stage span { font-size: 1.4rem; }
        .stage-active { opacity: 1; filter: grayscale(0); transform: scale(1.1); }

        #completion-tracker { font-size: 0.65rem; color: #888; margin-top: 5px; font-style: italic; }

        #panel-resources { flex: 1; overflow-y: auto; padding: 25px; background: var(--bg-light); border-top: 2px solid var(--border-color); }
        .notes-area { margin-top: 15px; width: 100%; padding: 10px; border: 1px dashed var(--accent-color); border-radius: 6px; background: var(--panel-bg); color: var(--text-main); font-family: inherit; font-size: 0.85rem; resize: vertical; min-height: 60px; }
        .category-title-container { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent-color); margin: 25px 0 15px 0; padding-bottom: 5px; }
        .category-title { color: var(--primary-bg); margin: 0; font-size: 1.05rem; font-weight: bold; }
        .question-box { background: var(--question-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color); transition: all 0.3s; }
        .question-box.answered { border-left: 5px solid var(--accent-color); }
        .option { display: flex; align-items: flex-start; margin: 10px 0; cursor: pointer; font-size: 0.88rem; }
        .option input { margin-right: 12px; margin-top: 3px; accent-color: var(--accent-color); flex-shrink: 0; }
        
        .res-cat-header { background: var(--primary-bg); color: white; padding: 8px 15px; border-radius: 5px; font-size: 0.95rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0; }
        .res-level-tag { background: var(--accent-color); padding: 2px 10px; border-radius: 12px; font-size: 0.75rem; }
        .res-item { background: var(--panel-bg); padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.03); font-size: 0.9rem; position: relative; }
        .res-item a { color: var(--accent-color); font-weight: bold; text-decoration: none; }
        .res-meta { display: flex; gap: 10px; margin-top: 5px; font-size: 0.75rem; color: #777; }
        .ipp-badge { background: #eee; padding: 1px 6px; border-radius: 4px; color: var(--primary-bg); font-weight: bold; }
        .tp-badge { border: 1px solid #ddd; padding: 1px 6px; border-radius: 4px; text-transform: uppercase; }

        #res-preview-tooltip { position: absolute; display: none; z-index: 2000; width: 280px; background: var(--panel-bg); border: 2px solid var(--primary-bg); border-radius: 8px; padding: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); font-size: 0.85rem; pointer-events: none; color: var(--text-main); }
        .info-icon { display: inline-flex; justify-content: center; align-items: center; width: 16px; height: 16px; background: var(--accent-color); color: white; border-radius: 50%; font-size: 10px; font-style: normal; margin-left: 5px; cursor: help; vertical-align: middle; }
    </style>
</head>
<body>

<header>
    <h1>Outils de positionnement de mes habilet√©s technologiques en FAD</h1>
    <div class="header-profile">Bonjour <input type="text" id="user-name" placeholder="Enseignant(e)" oninput="autoSaveData()">, voici votre bilan.</div>
    <div class="action-station">
        <button class="action-card btn-card-danger" onclick="resetForm()"><span>üîÑ</span> R√©initialiser</button>
        <button class="action-card btn-card-gestion" onclick="saveJSON()"><span>üíæ</span> Sauvegarder</button>
        <button class="action-card btn-card-gestion" onclick="document.getElementById('fileInput').click()"><span>üìÇ</span> Ouvrir</button>
        <input type="file" id="fileInput" style="display:none" onchange="loadJSON(event)">
        <button class="action-card btn-card-result" onclick="exportPDF()"><span>üìã</span> Plan PDF</button>
        <button class="action-card btn-card-result" onclick="window.print()"><span>üñ®Ô∏è</span> Imprimer</button>
        <div class="settings-stack">
            <button class="dark-mode-card" onclick="toggleDarkMode()" id="dark-icon" title="Mode Sombre">üåô</button>
            <div class="save-indicator" id="save-cloud" title="Sauvegarde auto">‚òÅÔ∏è</div>
        </div>
    </div>
</header>

<div id="res-preview-tooltip"></div>

<main>
    <section id="panel-questions">
        <div class="quick-nav">
            <button class="nav-btn" onclick="document.getElementById('cat-0').scrollIntoView()">1. √âlaboration</button>
            <button class="nav-btn" onclick="document.getElementById('cat-1').scrollIntoView()">2. D√©marche</button>
            <button class="nav-btn" onclick="document.getElementById('cat-2').scrollIntoView()">3. Organisation</button>
            <button class="nav-btn" onclick="document.getElementById('cat-3').scrollIntoView()">4. Encadrement</button>
        </div>
        <div id="questions-list"></div>
    </section>

    <div id="right-container">
        <section id="panel-chart">
            <div class="pillars-container">
                <div id="global-avg-line"></div>
                <div class="pillar-wrapper">
                    <div class="pillar-glass"><div class="pillar-fill" id="fill-0" style="background:var(--color-cat-0);"><div class="pillar-dots"></div></div></div>
                    <span class="pillar-label">1. √âlaboration</span>
                </div>
                <div class="pillar-wrapper">
                    <div class="pillar-glass"><div class="pillar-fill" id="fill-1" style="background:var(--color-cat-1);"><div class="pillar-dots"></div></div></div>
                    <span class="pillar-label">2. D√©marche</span>
                </div>
                <div class="pillar-wrapper">
                    <div class="pillar-glass"><div class="pillar-fill" id="fill-2" style="background:var(--color-cat-2);"><div class="pillar-dots"></div></div></div>
                    <span class="pillar-label">3. Organisation</span>
                </div>
                <div class="pillar-wrapper">
                    <div class="pillar-glass"><div class="pillar-fill" id="fill-3" style="background:var(--color-cat-3);"><div class="pillar-dots"></div></div></div>
                    <span class="pillar-label">4. Encadrement</span>
                </div>
            </div>
            
            <div id="gauge-label">Moyenne : 0.00</div>

            <div id="archetype-container" style="display:none">
                <div id="profile-type-badge">ARCH√âTYPE</div>
                <div id="profile-description">Description du profil...</div>
            </div>

            <div class="growth-container">
                <div class="growth-stage" id="stage-debut"><span>üå±</span></div>
                <div class="growth-stage" id="stage-inter"><span>üåø</span></div>
                <div class="growth-stage" id="stage-expert"><span>üå≥</span></div>
            </div>
            <div id="completion-tracker">0 / 20 questions r√©pondues</div>
        </section>

        <section id="panel-resources">
            <h2 style="margin-top:0">Votre Plan de Formation Personnalis√©</h2>
            <div id="resList"><p>R√©pondez au questionnaire pour g√©n√©rer vos recommandations sur mesure.</p></div>
        </section>
    </div>
</main>

<script>
    const externalResources = {
        "1.1": {
            "A": [{"t": "Guide: Intro FAD (TELUQ)", "u": "https://jenseigne-a-distance.teluq.ca/", "ipp": 9.8, "tp": "Guide"}],
            "B": [{"t": "Mod√®le ADDIE appliqu√©", "u": "https://www.pedagoform.fr/methode-addie/", "ipp": 9.5, "tp": "M√©thode"}],
            "C": [{"t": "Mod√®le SAM (Agile Design)", "u": "https://www.alleninteractions.com/sam-process", "ipp": 9.7, "tp": "Expert"}]
        },
        "2.1": {
            "A": [{"t": "Taxonomie de Bloom (U. Laval)", "u": "https://bit.ly/Bloom-ULaval", "ipp": 9.9, "tp": "Guide"}],
            "B": [{"t": "Alignement Constructif de Biggs", "u": "https://pbi.uottawa.ca/fr/alignement-pedagogique", "ipp": 9.6, "tp": "Recherche"}],
            "C": [{"t": "Understanding by Design (ASCD)", "u": "https://www.ascd.org/ubd", "ipp": 9.8, "tp": "Expert"}]
        },
        "3.2": { "A": [{"t": "Principes UX de Nielsen", "u": "https://www.nngroup.com/", "ipp": 9.9, "tp": "Standard"}] },
        "4.3": { "C": [{"t": "Ing√©nierie du tutorat (Rodet)", "u": "http://blogdetad.blogspot.com/", "ipp": 9.9, "tp": "Expert"}] }
    };

    const archetypes = {
        strat√®ge: { t: "Le Strat√®ge", d: "Profil √©quilibr√©. Vous jonglez avec brio entre technique, p√©dagogie et accompagnement." },
        architecte: { t: "L'Architecte", d: "Expert en planification. Votre force r√©side dans le design p√©dagogique et la structure." },
        facilitateur: { t: "Le Facilitateur", d: "L'humain est au c≈ìur. Vous privil√©giez un encadrement bienveillant et un soutien constant." },
        explorateur: { t: "L'Explorateur Techno", d: "Ma√Ætre des outils. Vous dynamisez vos cours par l'innovation et les ressources multim√©dias." }
    };

    const glossary = { "ADDIE": "Design : Analyse, Design, D√©v., Imp., √âval.", "Triple concordance": "Alignement Objectifs/Activit√©s/√âvals.", "AFEST": "Action Formation Situation Travail." };
    function addGlossaryIcon(term) { return `<span style="border-bottom: 1px dotted var(--accent-color); cursor:help" onmouseenter="showPreview(event, '${term}', '${glossary[term]}')" onmouseleave="hidePreview()">${term}<i class="info-icon">i</i></span>`; }

    const questions = [
        { id: 0, cat: "1. √âLABORATION DU COURS", q: [
            { id: "q1", map: "1.1", t: `1.1 Mod√®le utilis√© (${addGlossaryIcon('ADDIE')}) ?`, a: "Non, pr√©sentiel", b: "Pas syst√©matiquement", c: "R√©guli√®rement" },
            { id: "q2", map: "1.2", t: "1.2 Test des outils technologiques ?", a: "Non", b: "Quelques-uns", c: "Tout" },
            { id: "q3", map: "1.3", t: "1.3 Ressources existantes ?", a: "Tout cr√©er", b: "Occasionnellement", c: "Inventaire complet" },
            { id: "q4", map: "1.4", t: "1.4 √âquipe multidisciplinaire ?", a: "Seul", b: "Ponctuellement", c: "√âquipe" },
            { id: "q5", map: "1.5", t: "1.5 Am√©lioration continue ?", a: "Non", b: "Commentaires", c: "Plan formel" }
        ]},
        { id: 1, cat: "2. D√âMARCHE D'APPRENTISSAGE", q: [
            { id: "q6", map: "2.1", t: `2.1 ${addGlossaryIcon('Triple concordance')} ?`, a: "Pas toujours", b: "In√©gal", c: "Syst√©matique" },
            { id: "q7", map: "2.2", t: "2.2 Vari√©t√© des activit√©s ?", a: "Lectures", b: "Moyenne", c: "Grande" },
            { id: "q8", map: "2.3", t: "2.3 Choix apprenants ?", a: "Unique", b: "Limit√©", c: "Plusieurs" },
            { id: "q9", map: "2.4", t: "2.4 Structure contenu ?", a: "Long", b: "Unit√©s", c: "Cibl√©" },
            { id: "q10", map: "2.5", t: "2.5 Clart√© attentes ?", a: "D√©duire", b: "Ponctuelle", c: "Affich√©" }
        ]},
        { id: 2, cat: "3. ORGANISATION DU COURS", q: [
            { id: "q11", map: "3.1", t: "3.1 Plan FAD ?", a: "Adapt√©", b: "Incomplet", c: "Complet" },
            { id: "q12", map: "3.2", t: "3.2 Interface num√©rique ?", a: "D√©cousu", b: "Peu intuitif", c: "Convivial" },
            { id: "q13", map: "3.3", t: "3.3 Multim√©dias ?", a: "Texte", b: "Vid√©os", c: "Interactif" },
            { id: "q14", map: "3.4", t: "3.4 Choix justifi√©s ?", a: "Populaires", b: "Partiels", c: "Clair" },
            { id: "q15", map: "3.5", t: `3.5 Synchrone / Asynchrone ?`, a: "D√©s√©quilibr√©", b: "Mixte", c: "Pens√©" }
        ]},
        { id: 3, cat: "4. ENCADREMENT DES APPRENANTS", q: [
            { id: "q16", map: "4.1", t: "4.1 Accueil ?", a: "D√©brouillardise", b: "Message", c: "S√©ance" },
            { id: "q17", map: "4.2", t: "4.2 Formation outils ?", a: "Acquis", b: "Guides", c: "Proactif" },
            { id: "q18", map: "4.3", t: `4.3 N√©tiquette ?`, a: "Non", b: "Peu clair", c: "Pr√©cis" },
            { id: "q19", map: "4.4", t: "4.4 Autonomie ?", a: "Eux", b: "Conseils", c: "Strat√©gies" },
            { id: "q20", map: "4.5", t: `4.5 Suivi ${addGlossaryIcon('AFEST')} ?`, a: "Non", b: "Ponctuel", c: "R√©gulier" }
        ]}
    ];

    const qList = document.getElementById('questions-list');
    questions.forEach(group => {
        qList.innerHTML += `<div class="category-title-container" id="cat-${group.id}"><h3 class="category-title">${group.cat}</h3><span class="cat-progress-badge" id="badge-${group.id}">0%</span></div>`;
        group.q.forEach(item => {
            qList.innerHTML += `<div class="question-box" id="box-${item.id}"><span class="question-text">${item.t}</span>
                <label class="option"><input type="radio" name="${item.id}" data-map="${item.map}" value="A" onchange="updateProgression('${item.id}')"> A) ${item.a}</label>
                <label class="option"><input type="radio" name="${item.id}" data-map="${item.map}" value="B" onchange="updateProgression('${item.id}')"> B) ${item.b}</label>
                <label class="option"><input type="radio" name="${item.id}" data-map="${item.map}" value="C" onchange="updateProgression('${item.id}')"> C) ${item.c}</label></div>`;
        });
        qList.innerHTML += `<textarea class="notes-area" id="notes-${group.id}" placeholder="Notes..." oninput="autoSaveData()"></textarea>`;
    });

    function showPreview(e, title, desc) { 
        const tooltip = document.getElementById('res-preview-tooltip');
        tooltip.innerHTML = `<h4>${title}</h4><p>${desc}</p>`; tooltip.style.display = 'block'; tooltip.style.left = (e.pageX + 15) + 'px'; tooltip.style.top = (e.pageY + 15) + 'px'; 
    }
    function hidePreview() { document.getElementById('res-preview-tooltip').style.display = 'none'; }

    function updateProgression(lastId) {
        if(lastId) document.getElementById('box-'+lastId).classList.add('answered');
        let sumGlobal = 0, totalAnswered = 0, resHtml = "";
        let catAverages = [];

        questions.forEach((group, idx) => {
            let catSum = 0, catCount = 0;
            let catResources = [];
            group.q.forEach(q => {
                const el = document.querySelector(`input[name="${q.id}"]:checked`);
                if(el) { 
                    const val = el.value === 'A' ? 1 : (el.value === 'B' ? 2 : 3);
                    catSum += val; catCount++; 
                    if(externalResources[q.map] && externalResources[q.map][el.value]) {
                        externalResources[q.map][el.value].forEach(res => catResources.push({ ...res, fromQ: q.map }));
                    }
                }
            });

            const catAvg = catCount > 0 ? catSum / catCount : 0;
            catAverages.push(catAvg);
            sumGlobal += catSum; totalAnswered += catCount;
            document.getElementById('badge-'+group.id).innerText = Math.round((catCount / 5) * 100) + "%";

            // --- LOGIQUE DE LA JAUGE (PILIER) DEMAND√âE ---
            let targetMax = 0;
            if (catAvg > 0) {
                if (catAvg <= 1.6) targetMax = 33.33;       // D√©butant -> Tier
                else if (catAvg <= 2.4) targetMax = 50;    // Interm√©diaire -> Moiti√©
                else targetMax = 100;                     // Avanc√© -> 100%
            }
            
            // On remplit au prorata des questions r√©pondues (catCount/5)
            const finalFill = targetMax * (catCount / 5);
            document.getElementById(`fill-${idx}`).style.height = finalFill + "%";

            if(catCount > 0) {
                let label = catAvg <= 1.6 ? "D√âBUTANT" : (catAvg <= 2.4 ? "INTERM√âDIAIRE" : "EXPERT");
                resHtml += `<div class="res-cat-block"><div class="res-cat-header">${group.cat} <span class="res-level-tag">${label}</span></div>`;
                catResources.sort((a,b) => b.ipp - a.ipp).forEach(res => {
                    resHtml += `<div class="res-item"><div style="font-size:0.7rem; color:var(--accent-color)">REF: Q.${res.fromQ}</div><strong>${res.t}</strong><div class="res-meta"><span class="ipp-badge">Impact: ${res.ipp}</span><span class="tp-badge">${res.tp}</span></div><a href="${res.u}" target="_blank">Acc√©der ‚Üí</a></div>`;
                });
                resHtml += `</div>`;
            }
        });

        let globalAvg = totalAnswered > 0 ? (sumGlobal / totalAnswered) : 0;
        const line = document.getElementById('global-avg-line');
        if(globalAvg > 0) {
            line.style.opacity = 1;
            line.style.bottom = (11 + (((globalAvg - 1) / 2) * 130)) + "px";
        }

        const sD = document.getElementById('stage-debut'), sI = document.getElementById('stage-inter'), sE = document.getElementById('stage-expert');
        [sD, sI, sE].forEach(s => s.classList.remove('stage-active'));
        let gLvl = "√Ä d√©terminer", gCol = "#888";
        if(globalAvg > 0) {
            if(globalAvg <= 1.6) { gLvl = "D√âBUTANT"; gCol = '#FF8F00'; sD.classList.add('stage-active'); }
            else if(globalAvg <= 2.4) { gLvl = "INTERM√âDIAIRE"; gCol = '#00B0FF'; sD.classList.add('stage-active'); sI.classList.add('stage-active'); }
            else { gLvl = "AVANC√â"; gCol = '#00E676'; sD.classList.add('stage-active'); sI.classList.add('stage-active'); sE.classList.add('stage-active'); }
        }
        
        if(totalAnswered >= 5) {
            document.getElementById('archetype-container').style.display = 'block';
            let cat0 = catAverages[0] || 0, cat1 = catAverages[1] || 0, cat2 = catAverages[2] || 0, cat3 = catAverages[3] || 0;
            let personaKey = (cat0 >= Math.max(cat1, cat2, cat3)) ? "architecte" : (cat3 >= Math.max(cat0, cat1, cat2)) ? "facilitateur" : (cat2 >= Math.max(cat0, cat1, cat3)) ? "explorateur" : "strat√®ge";
            document.getElementById('profile-type-badge').innerText = archetypes[personaKey].t;
            document.getElementById('profile-description').innerText = archetypes[personaKey].d;
        }

        document.getElementById('gauge-label').innerText = `Moyenne : ${globalAvg.toFixed(2)} (${gLvl})`;
        document.getElementById('gauge-label').style.color = gCol;
        document.getElementById('completion-tracker').innerText = totalAnswered + " / 20 questions r√©pondues";
        document.getElementById('resList').innerHTML = resHtml || "<p>R√©pondez au questionnaire.</p>";
        autoSaveData();
    }

    function autoSaveData() {
        const data = { name: document.getElementById('user-name').value, answers: {}, notes: {} };
        document.querySelectorAll('input:checked').forEach(i => data.answers[i.name] = i.value);
        for(let i=0; i<4; i++) data.notes[i] = document.getElementById(`notes-${i}`).value;
        localStorage.setItem('fad_v2_data', JSON.stringify(data));
    }

    function saveJSON() {
        const data = localStorage.getItem('fad_v2_data');
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([data], {type: "application/json"})); a.download = "bilan_fad.json"; a.click();
    }

    function loadJSON(e) {
        const reader = new FileReader();
        reader.onload = ev => {
            const data = JSON.parse(ev.target.result);
            document.getElementById('user-name').value = data.name || "";
            for(let k in data.answers) { let r = document.querySelector(`input[name="${k}"][value="${data.answers[k]}"]`); if(r) r.checked = true; }
            for(let k in data.notes) if(document.getElementById(`notes-${k}`)) document.getElementById(`notes-${k}`).value = data.notes[k];
            updateProgression();
        };
        reader.readAsText(e.target.files[0]);
    }

    function resetForm() {
        if(confirm("Effacer ?")) {
            localStorage.removeItem('fad_v2_data');
            location.reload();
        }
    }

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
    }

    window.onload = () => {
        const saved = localStorage.getItem('fad_v2_data');
        if(saved) {
            const data = JSON.parse(saved);
            document.getElementById('user-name').value = data.name || "";
            for(let k in data.answers) { let r = document.querySelector(`input[name="${k}"][value="${data.answers[k]}"]`); if(r) r.checked = true; }
            for(let k in data.notes) if(document.getElementById(`notes-${k}`)) document.getElementById(`notes-${k}`).value = data.notes[k];
            updateProgression();
        }
    };
</script>
</body>
</html>
