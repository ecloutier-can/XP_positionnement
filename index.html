<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outils de positionnement de mes habilet√©s technologiques en FAD</title>
    <!-- Biblioth√®ques externes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-bg: #2e3192;
            /* Slightly darker accent to improve text/link contrast on light backgrounds */
            --accent-color: #00796b;
            --header-height: 230px;
            --bg-light: #f4f7f6;
            --panel-bg: #ffffff;
            --text-main: #333333;
            --question-bg: #f8f9fa;
            --border-color: #dddddd;
            
            --color-cat-0: #FF8F00; /* √âlaboration */
            --color-cat-1: #00B0FF; /* D√©marche */
            --color-cat-2: #00E676; /* Organisation */
            --color-cat-3: #D500F9; /* Encadrement */

            --color-debutant: #FF8F00;
            --color-inter: #00B0FF;
            --color-expert: #00E676;

            --card-border-danger: #e74c3c;
            --card-border-gestion: #00a99d;
            --card-border-result: #8e44ad;
        }

        .dark-mode {
            --bg-light: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --question-bg: #2d2d2d;
            --border-color: #444444;
            --accent-color: #00d1c1;
        }

        * { box-sizing: border-box; scroll-behavior: smooth; }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            background-color: var(--bg-light);
            color: var(--text-main);
            transition: background 0.3s, color 0.3s;
        }

        header {
            height: var(--header-height);
            background: linear-gradient(135deg, #1b1e5d 0%, #2e3192 100%);
            color: white;
            padding: 20px 30px;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
            box-shadow: 0 3px 15px rgba(0,0,0,0.3);
            z-index: 1000; flex-shrink: 0;
        }

        header h1 { margin: 0; font-size: 1.8rem; text-transform: uppercase; letter-spacing: 1px; text-align: center; }
        .header-profile { display: flex; align-items: center; gap: 10px; font-size: 1.1rem; margin: 5px 0; opacity: 0.9; }

        #user-name {
            background: rgba(255,255,255,0.1); border: none; border-bottom: 2px solid var(--accent-color);
            color: white; padding: 2px 10px; font-weight: bold; text-align: center; width: 220px; border-radius: 4px 4px 0 0;
        }

        .action-station { display: flex; gap: 12px; justify-content: center; width: 100%; margin-top: 12px; align-items: center; }

        /* Harmonisation des boutons d'action dans l'en-t√™te */
        button.action-card {
            background: rgba(255,255,255,0.08); /* l√©ger fond translucide pour s'int√©grer au header */
            color: white; border: none; /* suppression bord externe pour un look plus moderne */
            padding: 8px 14px; border-radius: 999px; cursor: pointer; font-weight: 700; font-size: 0.92rem;
            transition: transform 0.22s ease, box-shadow 0.22s ease, filter 0.18s ease;
            display: inline-flex; flex-direction: row; align-items: center; gap: 10px; box-shadow: none; min-width: 80px;
            border-bottom: 3px solid transparent; /* r√©serv√© aux classes de couleur (danger/gestion/result) */
            backdrop-filter: blur(4px);
        }
        /* Ic√¥ne ronde √† gauche (maintenant .icon) */
        .action-card .icon {
            display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px;
            border-radius: 50%; background: rgba(255,255,255,0.12); font-size: 14px; line-height: 1; box-shadow: 0 2px 6px rgba(0,0,0,0.12);
        }
        .action-card .icon svg { width: 18px; height: 18px; color: white; }
        .action-card .btn-label { display: inline-block; }
        /* Focus visible accessible pour les boutons (clavier) */
        button.action-card:focus { outline: none; box-shadow: 0 0 0 4px rgba(0,169,157,0.18), 0 6px 18px rgba(0,0,0,0.18); transform: translateY(-3px); }
        button.action-card:focus .icon { background: rgba(255,255,255,0.16); }
        /* Garder les couleurs sp√©cifiques via la bordure inf√©rieure */
        .btn-card-danger { border-bottom-color: var(--card-border-danger) !important; }
        .btn-card-gestion { border-bottom-color: var(--card-border-gestion) !important; }
        .btn-card-result { border-bottom-color: var(--card-border-result) !important; }
        button.action-card:hover { transform: translateY(-6px); box-shadow: 0 10px 18px rgba(0,0,0,0.22); filter: brightness(1.06); }

        /* Dark mode: ajuster le contraste des boutons */
        .dark-mode header button.action-card { background: rgba(255,255,255,0.04); color: white; }
        .dark-mode header button.action-card > span { background: rgba(255,255,255,0.06); }

    /* Indicateur de sauvegarde : √©tat actif (en cours) et succ√®s */
    .save-indicator { cursor: default; display: inline-flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 999px; background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.95); transition: transform 0.18s, opacity 0.18s, box-shadow 0.2s; font-weight:600 }
    .save-indicator .cloud-svg { width: 18px; height: 18px; display:inline-block; }
    .save-indicator .cloud-svg svg { width:100%; height:100%; color: white; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.25)); }
    .save-indicator.active { animation: pulseBig 1s infinite; transform: scale(1.03); box-shadow: 0 6px 22px rgba(0,169,157,0.16); }
    .save-indicator.success { animation: pop 0.45s ease forwards; color: #ffffff; background: linear-gradient(90deg,#2ecc71,#27ae60); box-shadow: 0 8px 28px rgba(39,174,96,0.28); }
    @keyframes pulseBig { 0% { box-shadow: 0 0 0 0 rgba(0,169,157,0.14);} 50% { box-shadow: 0 0 0 14px rgba(0,169,157,0.02);} 100% { box-shadow: 0 0 0 0 rgba(0,169,157,0.0);} }
    @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.18); } 100% { transform: scale(1); } }
    .sr-only { position: absolute !important; width: 1px !important; height: 1px !important; padding: 0 !important; margin: -1px !important; overflow: hidden !important; clip: rect(0,0,0,0) !important; white-space: nowrap !important; border: 0 !important; }

    /* Top-left placement for dark/save tools */
    .top-left-tools { position: absolute; left: 16px; top: 12px; display: flex; gap: 10px; align-items: center; z-index: 1200; }
    .top-left-tools .dark-mode-card { padding: 6px; border-radius: 8px; background: rgba(255,255,255,0.02); color: rgba(255,255,255,0.85); font-size: 0.9rem; }
    .top-left-tools .dark-mode-card:hover { background: rgba(255,255,255,0.04); }
    /* compact save indicator in top-left */
    .top-left-tools .save-indicator { padding: 6px; gap:6px; background: transparent; box-shadow: none; }
    .top-left-tools .save-indicator .cloud-svg svg { width:16px; height:16px; }
    .top-left-tools .save-indicator.active { box-shadow: 0 6px 18px rgba(0,169,157,0.12); transform: scale(1.02); }
    .top-left-tools .save-indicator.success { background: rgba(39,174,96,0.12); color: white; box-shadow: 0 8px 20px rgba(39,174,96,0.18); }

    .settings-stack { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; margin-left: 8px; }
        .dark-mode-card { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: white; transition: transform 0.3s; }
    .dark-mode-card .icon { display:inline-flex; align-items:center; justify-content:center; width:26px; height:26px; }
    .dark-mode-card .icon svg { width:20px; height:20px; color: white; }

        main { display: flex; flex: 1; height: calc(100vh - var(--header-height)); overflow: hidden; }

        #panel-questions { width: 550px; background: var(--panel-bg); border-right: 1px solid var(--border-color); overflow-y: auto; padding: 25px; flex-shrink: 0; position: relative; }

        .quick-nav { display: flex; gap: 5px; margin-bottom: 20px; position: sticky; top: -25px; background: var(--panel-bg); padding: 10px 0; z-index: 100; border-bottom: 1px solid var(--border-color); }
        .nav-btn { background: var(--question-bg); border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-weight: bold; color: var(--text-main);}

        #right-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* --- Section Ma√Ætrise Globale : Piliers de Cristal --- */
        #panel-chart {
            height: 380px; background: var(--panel-bg); border-bottom: 1px solid var(--border-color);
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center; 
            padding: 15px; flex-shrink: 0;
            background: radial-gradient(circle at center, var(--panel-bg) 0%, var(--bg-light) 100%);
            position: relative;
        }

        .pillars-container {
            display: flex; justify-content: space-around; align-items: flex-end;
            width: 100%; max-width: 500px; height: 160px; margin: 10px 0;
            position: relative; padding: 0 20px;
        }

        .pillar-wrapper {
            display: flex; flex-direction: column; align-items: center; width: 60px; height: 100%;
        }

        .pillar-glass {
            width: 35px; height: 130px; background: rgba(0,0,0,0.05); border: 1px solid var(--border-color);
            border-radius: 5px; position: relative; overflow: hidden;
            display: flex; align-items: flex-end;
        }
        .dark-mode .pillar-glass { background: rgba(255,255,255,0.05); }

        .pillar-fill {
            width: 100%; height: 0%; transition: height 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        /* Effet de grille √† l'int√©rieur des piliers */
        .pillar-dots {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(rgba(255,255,255,0.3) 1px, transparent 1px);
            background-size: 4px 4px; pointer-events: none;
        }

        .pillar-label { font-size: 0.65rem; font-weight: bold; margin-top: 8px; text-transform: uppercase; color: var(--primary-bg); text-align: center; }
        .dark-mode .pillar-label { color: var(--accent-color); }

        /* Ligne de convergence globale */
        #global-avg-line {
            position: absolute; left: 45px; right: 45px; height: 2px;
            background: white; box-shadow: 0 0 10px white;
            z-index: 10; opacity: 0; transition: bottom 1s, opacity 0.5s;
            pointer-events: none;
        }
        #global-avg-line::after {
            content: 'Moyenne'; position: absolute; right: -40px; top: -7px;
            font-size: 0.5rem; font-weight: bold; color: var(--primary-bg);
            background: white; padding: 2px 4px; border-radius: 3px;
        }

        #gauge-label { font-weight: bold; font-size: 1.3rem; margin-top: 5px; text-align: center; }

        #archetype-container { margin-top: 5px; text-align: center; }
        #profile-type-badge { display: inline-block; font-size: 0.85rem; font-weight: 800; padding: 4px 14px; border-radius: 20px; background: var(--primary-bg); color: white; text-transform: uppercase; letter-spacing: 1px; }
        #profile-description { font-size: 0.75rem; margin-top: 4px; color: var(--text-main); font-style: italic; max-width: 400px; line-height: 1.2; }

        .growth-container { display: flex; gap: 30px; margin-top: 10px; }
    .growth-stage { display: flex; flex-direction: column; align-items: center; opacity: 0.2; filter: grayscale(100%); transition: all 0.5s; }
        .growth-stage span { font-size: 1.4rem; }
        .stage-active { opacity: 1; filter: grayscale(0); transform: scale(1.1); }

    /* Improved contrast for small helper text */
    #completion-tracker { font-size: 0.65rem; color: #555; margin-top: 5px; font-style: italic; }

        #panel-resources { flex: 1; overflow-y: auto; padding: 25px; background: var(--bg-light); border-top: 2px solid var(--border-color); }
        .notes-area { margin-top: 15px; width: 100%; padding: 10px; border: 1px dashed var(--accent-color); border-radius: 6px; background: var(--panel-bg); color: var(--text-main); font-family: inherit; font-size: 0.85rem; resize: vertical; min-height: 60px; }
        .category-title-container { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent-color); margin: 25px 0 15px 0; padding-bottom: 5px; }
        .category-title { color: var(--primary-bg); margin: 0; font-size: 1.05rem; font-weight: bold; }
        .question-box { background: var(--question-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color); transition: all 0.3s; }
        .question-box.answered { border-left: 5px solid var(--accent-color); }
        .option { display: flex; align-items: flex-start; margin: 10px 0; cursor: pointer; font-size: 0.88rem; }
        .option input { margin-right: 12px; margin-top: 3px; accent-color: var(--accent-color); flex-shrink: 0; }
        .res-cat-header { background: var(--primary-bg); color: white; padding: 8px 15px; border-radius: 5px; font-size: 0.95rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .res-level-tag { background: var(--accent-color); padding: 2px 10px; border-radius: 12px; font-size: 0.75rem; }
        .res-item { background: var(--panel-bg); padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.03); font-size: 0.9rem; }
    /* Use the primary (dark) color for links on light surfaces to meet contrast requirements */
    .res-item a { color: var(--primary-bg); font-weight: bold; text-decoration: none; }
        #res-preview-tooltip { position: absolute; display: none; z-index: 2000; width: 280px; background: var(--panel-bg); border: 2px solid var(--primary-bg); border-radius: 8px; padding: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); font-size: 0.85rem; pointer-events: none; color: var(--text-main); }
        .info-icon { display: inline-flex; justify-content: center; align-items: center; width: 16px; height: 16px; background: var(--accent-color); color: white; border-radius: 50%; font-size: 10px; font-style: normal; margin-left: 5px; cursor: help; vertical-align: middle; }
    </style>
    <link rel="stylesheet" href="styles/ui.css">
</head>
<body>

<!-- SVG sprite (Heroicons-like) - symbols reused across the UI -->
<svg aria-hidden="true" style="display:none">
    <symbol id="icon-refresh" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20.49 9A9 9 0 1 0 21 12" />
        <path d="M21 3v6h-6" />
    </symbol>
    <symbol id="icon-save" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 3v12" />
        <path d="M8 11l4-4 4 4" />
        <path d="M21 21H3" />
    </symbol>
    <symbol id="icon-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7" />
        <path d="M16 3h-8l-2 4h12l-2-4z" />
    </symbol>
    <symbol id="icon-doc" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
        <path d="M14 2v6h6" />
        <path d="M16 13H8" />
        <path d="M16 17H8" />
    </symbol>
    <symbol id="icon-print" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M6 9V3h12v6" />
        <path d="M6 18H4a2 2 0 0 1-2-2v-3h20v3a2 2 0 0 1-2 2h-2" />
        <path d="M6 14h12v8H6z" />
    </symbol>
    <symbol id="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
    </symbol>
    <symbol id="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="4" />
        <path d="M12 2v2" />
        <path d="M12 20v2" />
        <path d="M4.93 4.93l1.41 1.41" />
        <path d="M17.66 17.66l1.41 1.41" />
        <path d="M2 12h2" />
        <path d="M20 12h2" />
        <path d="M4.93 19.07l1.41-1.41" />
        <path d="M17.66 6.34l1.41-1.41" />
    </symbol>
    <symbol id="icon-cloud" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 17.58A4 4 0 0 0 16 14H15a4 4 0 0 0-7.75-1.5A3 3 0 1 0 4 18h12a4 4 0 0 0 4-4"/>
    </symbol>
</svg>

<header>
    <!-- Top-left tools: dark-mode + save indicator (moved for a more discrete placement) -->
    <div class="top-left-tools" aria-hidden="false">
        <button class="dark-mode-card" onclick="toggleDarkMode()" id="dark-icon" title="Basculer mode sombre" aria-label="Basculer mode sombre">
            <svg class="icon" aria-hidden="true"><use href="#icon-moon"></use></svg>
        </button>
        <div class="save-indicator" id="save-cloud" title="Sauvegarde auto" role="status" aria-live="polite" aria-label="Indicateur de sauvegarde">
            <span class="cloud-svg" aria-hidden="true"><svg class="icon"><use href="#icon-cloud"></use></svg></span>
            <span class="sr-only">Sauvegarde automatique</span>
        </div>
    </div>
    <h1>Outils de positionnement de mes habilet√©s technologiques en FAD</h1>
    <div class="header-profile">Bonjour <input type="text" id="user-name" placeholder="Enseignant(e)" aria-label="Nom de l'enseignant(e)" oninput="autoSaveData()">, voici votre bilan.</div>
        <div class="action-station">
        <button class="action-card btn-card-danger" onclick="resetForm()" aria-label="R√©initialiser le questionnaire">
            <svg class="icon" aria-hidden="true"><use href="#icon-refresh"></use></svg>
            <span class="btn-label">R√©initialiser</span>
        </button>
        <button class="action-card btn-card-gestion" onclick="saveJSON()" aria-label="T√©l√©charger la sauvegarde JSON">
            <svg class="icon" aria-hidden="true"><use href="#icon-save"></use></svg>
            <span class="btn-label">Sauvegarder</span>
        </button>
        <button class="action-card btn-card-gestion" onclick="document.getElementById('fileInput').click()" aria-label="Ouvrir un fichier JSON de sauvegarde">
            <svg class="icon" aria-hidden="true"><use href="#icon-open"></use></svg>
            <span class="btn-label">Ouvrir</span>
        </button>
    <input type="file" id="fileInput" aria-label="Importer un fichier JSON" style="display:none" onchange="loadJSON(event)">
        <button class="action-card btn-card-result" onclick="exportPDF()" aria-label="G√©n√©rer le plan PDF">
            <svg class="icon" aria-hidden="true"><use href="#icon-doc"></use></svg>
            <span class="btn-label">Plan PDF</span>
        </button>
        <button class="action-card btn-card-result" onclick="window.print()" aria-label="Imprimer la page">
            <svg class="icon" aria-hidden="true"><use href="#icon-print"></use></svg>
            <span class="btn-label">Imprimer</span>
        </button>
        <!-- tools moved to top-left for a more discrete placement -->
    </div>
</header>

<div id="res-preview-tooltip" role="tooltip" aria-hidden="true"></div>

<main>
    <section id="panel-questions">
        <div class="quick-nav">
            <button class="nav-btn" onclick="document.getElementById('cat-0').scrollIntoView()">1. √âlaboration</button>
            <button class="nav-btn" onclick="document.getElementById('cat-1').scrollIntoView()">2. D√©marche</button>
            <button class="nav-btn" onclick="document.getElementById('cat-2').scrollIntoView()">3. Organisation</button>
            <button class="nav-btn" onclick="document.getElementById('cat-3').scrollIntoView()">4. Encadrement</button>
        </div>
        <div id="questions-list"></div>
    </section>

    <div id="right-container">
        <section id="panel-chart">
            <div class="pillars-container">
                <div id="global-avg-line"></div>
                <div class="pillar-wrapper">
                    <div class="pillar-glass"><div class="pillar-fill" id="fill-0" style="background:var(--color-cat-0);"><div class="pillar-dots"></div></div></div>
                    <span class="pillar-label">1. √âlaboration</span>
                </div>
                <div class="pillar-wrapper">
                    <div class="pillar-glass"><div class="pillar-fill" id="fill-1" style="background:var(--color-cat-1);"><div class="pillar-dots"></div></div></div>
                    <span class="pillar-label">2. D√©marche</span>
                </div>
                <div class="pillar-wrapper">
                    <div class="pillar-glass"><div class="pillar-fill" id="fill-2" style="background:var(--color-cat-2);"><div class="pillar-dots"></div></div></div>
                    <span class="pillar-label">3. Organisation</span>
                </div>
                <div class="pillar-wrapper">
                    <div class="pillar-glass"><div class="pillar-fill" id="fill-3" style="background:var(--color-cat-3);"><div class="pillar-dots"></div></div></div>
                    <span class="pillar-label">4. Encadrement</span>
                </div>
            </div>
            
            <div id="gauge-label">Moyenne : 0.00</div>

            <div id="archetype-container" style="display:none">
                <div id="profile-type-badge">ARCH√âTYPE</div>
                <div id="profile-description">Description du profil...</div>
            </div>

            <div class="growth-container">
                <div class="growth-stage" id="stage-debut"><span aria-hidden="true">üå±</span></div>
                <div class="growth-stage" id="stage-inter"><span aria-hidden="true">üåø</span></div>
                <div class="growth-stage" id="stage-expert"><span aria-hidden="true">üå≥</span></div>
            </div>
            <div id="completion-tracker">0 / 20 questions r√©pondues</div>
        </section>

        <section id="panel-resources">
            <h2 style="margin-top:0">Votre Plan de Formation Personnalis√©</h2>
            <div id="resList"><p>R√©pondez au questionnaire pour g√©n√©rer vos recommandations sur mesure.</p></div>
            <div id="transversal-resources">
                <div class="category-title">ORGANISMES & COMMUNAUT√âS D'EXPERTS</div>
                <div class="res-item"><strong>FADIO</strong> - Expertise Qu√©bec. <a href="https://fadio.net/" target="_blank" rel="noopener noreferrer" onmouseenter="showPreview(event, 'FADIO', 'Partage d‚Äôexpertise interordres au Qu√©bec.')" onmouseleave="hidePreview()" onfocus="showPreview(event, 'FADIO', 'Partage d‚Äôexpertise interordres au Qu√©bec.')" onblur="hidePreview()">Visiter</a></div>
                <div class="res-item"><strong>CADRE21</strong> - Badges num√©riques. <a href="https://www.cadre21.org/axefad/" target="_blank" rel="noopener noreferrer" onmouseenter="showPreview(event, 'CADRE21', 'Formations certifi√©es enseignants.')" onmouseleave="hidePreview()" onfocus="showPreview(event, 'CADRE21', 'Formations certifi√©es enseignants.')" onblur="hidePreview()">Visiter</a></div>
                <div style="text-align: center; margin-top: 15px;">
                    <!-- Temporary visible SVG thumbnail (test) - keeps original href so clicking still opens the embedded PNG if needed -->
                    <a href="data:image/png;base64,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" aria-label="Illustration ressources FAD" title="Illustration ressources FAD">
                        <svg width="120" height="80" viewBox="0 0 120 80" role="img" aria-hidden="false" xmlns="http://www.w3.org/2000/svg" style="border-radius:10px; border:2px solid var(--accent-color); background:#ffffff; display:block;">
                            <rect width="100%" height="100%" fill="#f4f7f6" rx="8" ry="8"></rect>
                            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Segoe UI, Arial, sans-serif" font-size="14" fill="#2e3192">Plan de formation</text>
                        </svg>
                    </a>
                </div>
            </div>
        </section>
    </div>
</main>

<script>
    const archetypes = {
        strat√®ge: { t: "Le Strat√®ge", d: "Profil √©quilibr√©. Vous jonglez avec brio entre technique, p√©dagogie et accompagnement." },
        architecte: { t: "L'Architecte", d: "Expert en planification. Votre force r√©side dans le design p√©dagogique et la structure." },
        facilitateur: { t: "Le Facilitateur", d: "L'humain est au c≈ìur. Vous privil√©giez un encadrement bienveillant et un soutien constant." },
        explorateur: { t: "L'Explorateur Techno", d: "Ma√Ætre des outils. Vous dynamisez vos cours par l'innovation et les ressources multim√©dias." }
    };

    const glossary = { "ADDIE": "Design : Analyse, Design, D√©v., Imp., √âval.", "MISA": "Ing√©nierie Syst√®me Apprentissage.", "Triple concordance": "Alignement Objectifs/Activit√©s/√âvals.", "N√©tiquette": "Politesse num√©rique.", "AFEST": "Action Formation Situation Travail.", "Synchrone": "Temps r√©el.", "Asynchrone": "Diff√©r√©." };
    // Make glossary inline hints keyboard accessible (tab/focus) and mouse hover
    function addGlossaryIcon(term) { return `<span role="button" tabindex="0" style="border-bottom: 1px dotted var(--accent-color); cursor:help" onmouseenter="showPreview(event, '${term}', '${glossary[term]}')" onmouseleave="hidePreview()" onfocus="showPreview(event, '${term}', '${glossary[term]}')" onblur="hidePreview()">${term}<i class="info-icon">i</i></span>`; }

    const questions = [
        { id: 0, cat: "1. √âLABORATION DU COURS", q: [
            { id: "q1", t: `1.1 Mod√®le utilis√© (${addGlossaryIcon('ADDIE')}, ${addGlossaryIcon('MISA')}) ?`, a: "Non, exp√©rience pr√©sentiel", b: "Pas syst√©matiquement", c: "R√©guli√®rement adapt√©" },
            { id: "q2", t: "1.2 Test des outils technologiques ?", a: "Non", b: "Quelques outils", c: "Tout test√©" },
            { id: "q3", t: "1.3 Consultation ressources existantes ?", a: "Tout cr√©er", b: "Occasionnellement", c: "Inventaire complet" },
            { id: "q4", t: "1.4 √âquipe multidisciplinaire ?", a: "Seul", b: "Ponctuellement", c: "√âquipe compl√®te" },
            { id: "q5", t: "1.5 Plan d'am√©lioration continue ?", a: "Non", b: "Commentaires", c: "Plan formel" }
        ]},
        { id: 1, cat: "2. D√âMARCHE D'APPRENTISSAGE", q: [
            { id: "q6", t: `2.1 Respect de la ${addGlossaryIcon('Triple concordance')} ?`, a: "Pas toujours", b: "In√©gal", c: "Syst√©matique" },
            { id: "q7", t: "2.2 Vari√©t√© des activit√©s ?", a: "Lectures", b: "Moyenne", c: "Grande vari√©t√©" },
            { id: "q8", t: "2.3 Choix offerts aux apprenants ?", a: "Parcours unique", b: "Limit√©", c: "Plusieurs chemins" },
            { id: "q9", t: "2.4 Structure du contenu ?", a: "Cours longs", b: "Unit√©s larges", c: "√âl√©ments cibl√©s" },
            { id: "q10", t: "2.5 Clart√© des attentes ?", a: "√Ä d√©duire", b: "Ponctuelle", c: "Crit√®res affich√©s" }
        ]},
        { id: 2, cat: "3. ORGANISATION DU COURS", q: [
            { id: "q11", t: "3.1 Plan d'√©tudes sp√©cifique FAD ?", a: "Adapt√© pr√©sentiel", b: "Incomplet", c: "Complet" },
            { id: "q12", t: "3.2 Interface num√©rique ?", a: "D√©cousu", b: "Peu intuitif", c: "Convivial" },
            { id: "q13", t: "3.3 Ressources multim√©dias ?", a: "Texte/PDF", b: "Vid√©os simples", c: "Interactif/Podcast" },
            { id: "q14", t: "3.4 Choix justifi√©s ?", a: "Populaires", b: "Besoins partiels", c: "Raison claire" },
            { id: "q15", t: `3.5 √âquilibre ${addGlossaryIcon('Synchrone')} / ${addGlossaryIcon('Asynchrone')} ?`, a: "Asynchrone", b: "M√©lange in√©gal", c: "√âquilibre pens√©" }
        ]},
        { id: 3, cat: "4. ENCADREMENT DES APPRENANTS", q: [
            { id: "q16", t: "4.1 Accueil des apprenants ?", a: "D√©brouillardise", b: "Message simple", c: "S√©ance structur√©e" },
            { id: "q17", t: "4.2 Formation aux outils ?", a: "Suppos√© acquis", b: "Guides", c: "Proactif" },
            { id: "q18", t: `4.3 ${addGlossaryIcon('N√©tiquette')} et d√©lais ?`, a: "Non d√©finis", b: "Peu clair", c: "Pr√©cis" },
            { id: "q19", t: "4.4 Soutien autonomie ?", a: "√Ä eux de s'organiser", b: "Conseils", c: "Strat√©gies" },
            { id: "q20", t: `4.5 Engagement et ${addGlossaryIcon('AFEST')} ?`, a: "Travaux", b: "Ponctuel", c: "Suivi r√©gulier" }
        ]}
    ];

    const resourcesData = {
        0: { debut: [{t:"CADRE21 - Explorateur", d:"Structuration syst√©mique.", l:"https://cadre21.org/groupe-de-cours/scenarisation-pedagogique-en-fad"},{t:"TELUQ - Design", d:"Template pratique.", l:"https://jenseigneadistance.teluq.ca/mod/page/view.php?id=485"},{t:"Wikipedia - ADDIE", d:"Th√©orie.", l:"https://fr.wikipedia.org/wiki/Mod√®le_ADDIE"}], inter: [{t:"CADRE21 - Architecte", d:"Design complexe.", l:"https://www.cadre21.org/axefad/"}, {t:"C√©gep Trois-Rivi√®res", d:"Mod√®les FAD.", l:"https://pratiquesfad.ca/quel-modele-choisir-ca-depend/"}], expert: [{t:"CADRE21 - Innovateur", d:"Leadership FAD.", l:"https://www.cadre21.org/axefad/"}, {t:"Beedeez", d:"Mod√®les avanc√©s.", l:"https://www.beedeez.com/fr/blog/quest-ce-que-le-modele-addie"}] },
        1: { debut: [{t:"HEC Montr√©al - Alignement", d:"Triple concordance.", l:"https://enseigner.hec.ca/pedagogie/alignement-pedagogique/"}, {t:"CADRE21 - P√©dagogie active", d:"Bases.", l:"https://cadre21.org/groupe-de-cours/pedagogie-active-en-fad"}, {t:"Formagora", d:"M√©thode active.", l:"https://www.formagora.fr/actualites/quest-ce-que-la-methode-pedagogique-active-et-comment-la-pratiquer"}], inter: [{t:"CADRE21 - R√©pertoire", d:"20 strat√©gies.", l:"https://www.cadre21.org/axefad/repertoire-des-strategies-pedagogiques/"}, {t:"Univ. Bordeaux", d:"Alignement.", l:"https://enseigner.u-bordeaux.fr/politique-de-formation/"}], expert: [{t:"ENPC - Th√©ories", d:"Innovation.", l:"https://pedagotheque.enpc.fr/2016/05/04/quest-ce-que-la-pedagogie-active/"}, {t:"BBF - Mode d'emploi", d:"Projets/Cas.", l:"https://bbf.enssib.fr/consulter/bbf-2018-16-0016-002"}] },
        2: { debut: [{t:"Moodle - Lancement", d:"Fonctionnalit√©s.", l:"https://moodle.com/fr/"}, {t:"R√âCIT FAD - Technique", d:"Moodle/Outils.", l:"https://recitfad.ca/moodledocs/guide-conception-fad.html"}, {t:"Itslearning", d:"Optimisation.", l:"https://u2p-normandie.fr/optimiser-apprentissage-numerique/"}], inter: [{t:"AUF - Administration", d:"Gestion LMS.", l:"https://formations.auf.org/home/formation-ific/"}, {t:"R√âCIT FAD - Plugiciels", d:"Am√©liorer Moodle.", l:"https://ecolebranchee.com/plugiciels-sur-mesure-favoriser-apprentissage-moodle/"}], expert: [{t:"Moodle Workplace", d:"Personnalisation.", l:"https://moodle.com/fr/solutions/technologie-informatique/"}, {t:"FADIO - Ateliers", d:"Ing√©nierie r√©elle.", l:"https://fadio.net/evenements/semaine-de-la-formation-a-distance/ateliers-de-la-semaine-fad-2022/"}] },
        3: { debut: [{t:"The Conversation - Accompagner", d:"Motivation.", l:"https://theconversation.com/formation-a-distance-comment-accompagner-les-apprenants-quon-ne-rencontre-pas-241999"}, {t:"Sherpas", d:"Gestion du temps.", l:"https://sherpas.com/p/guide-soutien-scolaire/aider-gestion-temps-organisation.html"}, {t:"Le Social", d:"Sans rencontre.", l:"https://www.lesocial.fr/formation/1695-formation-a-distance-comment-accompagner-les-apprenants-quon-ne-rencontre-pas"}], inter: [{t:"OpenEdition - FOAD", d:"Approches techno.", l:"https://journals.openedition.org/dms/9061"}, {t:"EduQuest", d:"Autonomie.", l:"https://www.eduquest.fr/soutien-scolaire-a-domicile-comment-concilier-autonomie-et-encadrement/"}, {t:"WALT - Soutien", d:"Individualisation.", l:"https://www.walt-asso.fr/strategies-soutien-pedagogiques-individualisation-apprentissage/"}], expert: [{t:"Cabestan - AFEST", d:"Pratique r√©flexive.", l:"https://www.cabestan-formation.fr/formation-devenir-accompagnateur-afest-2-jours/"}, {t:"Icademie", d:"IA adaptive.", l:"https://www.icademie.com/fr/guide/les-differences-entre-formation-a-distance-fad-et-foad"}] }
    };

    const qList = document.getElementById('questions-list');
    questions.forEach(group => {
        qList.innerHTML += `<div class="category-title-container" id="cat-${group.id}"><h3 class="category-title">${group.cat}</h3><span class="cat-progress-badge" id="badge-${group.id}">0%</span></div>`;
        group.q.forEach(item => {
            qList.innerHTML += `<div class="question-box" id="box-${item.id}"><span class="question-text">${item.t}</span>
                <label class="option"><input type="radio" name="${item.id}" value="1" onchange="updateProgression('${item.id}')"> A) ${item.a}</label>
                <label class="option"><input type="radio" name="${item.id}" value="2" onchange="updateProgression('${item.id}')"> B) ${item.b}</label>
                <label class="option"><input type="radio" name="${item.id}" value="3" onchange="updateProgression('${item.id}')"> C) ${item.c}</label></div>`;
        });
        qList.innerHTML += `<textarea class="notes-area" id="notes-${group.id}" placeholder="R√©flexions pour ce domaine (optionnel)..." oninput="autoSaveData()"></textarea>`;
    });

    function showPreview(e, title, desc) { 
        const tooltip = document.getElementById('res-preview-tooltip');
        tooltip.innerHTML = `<h4>${title}</h4><p>${desc}</p>`;
        tooltip.style.display = 'block'; tooltip.style.left = (e.pageX + 15) + 'px'; tooltip.style.top = (e.pageY + 15) + 'px';
        tooltip.setAttribute('aria-hidden', 'false');
    }

    function hidePreview() { const t = document.getElementById('res-preview-tooltip'); t.style.display = 'none'; t.setAttribute('aria-hidden','true'); }

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const btn = document.getElementById('dark-icon');
        const moonUse = '<svg class="icon" aria-hidden="true"><use href="#icon-moon"></use></svg>';
        const sunUse = '<svg class="icon" aria-hidden="true"><use href="#icon-sun"></use></svg>';
        btn.innerHTML = document.body.classList.contains('dark-mode') ? sunUse : moonUse;
    }

    function exportPDF() {
        const name = document.getElementById('user-name').value || "Enseignant(e)";
        const element = document.createElement('div');
        
        // --- NOUVEAUT√â : R√©cup√©ration des r√©flexions pour le PDF ---
        let reflectionsHtml = "";
        for (let i = 0; i < 4; i++) {
            const note = document.getElementById(`notes-${i}`).value.trim();
            if (note) {
                reflectionsHtml += `<p><strong>R√©flexion sur ${questions[i].cat} :</strong><br>${note.replace(/\n/g, '<br>')}</p>`;
            }
        }
        if (reflectionsHtml) reflectionsHtml = `<hr><h3 style="color:#2e3192">MES R√âFLEXIONS</h3>` + reflectionsHtml;
        // -----------------------------------------------------------

        element.innerHTML = `<h1 style="color:#2e3192; text-align:center">BILAN FAD : ${name.toUpperCase()}</h1>
            <div style="padding:20px; border:1px solid #ddd; border-radius:10px">
                <h2>Profil : ${currentPersonaTitle}</h2>
                <p>Moyenne : ${currentAvg}</p>
                <hr>
                ${document.getElementById('resList').innerHTML}
                ${reflectionsHtml}
            </div>`;
        
        html2pdf().set({ margin: 10, filename: `PlanFAD_${name}.pdf`, html2canvas: { scale: 2 }, jsPDF: { format: 'a4' } }).from(element).save();
    }

    let currentPersonaTitle = "";
    let currentAvg = "0.00";

    function updateProgression(lastId) {
        if(lastId) document.getElementById('box-'+lastId).classList.add('answered');
        let sumGlobal = 0, totalAnswered = 0, resHtml = "";
        let catAverages = [];

        questions.forEach((group, idx) => {
            let catSum = 0, catCount = 0;
            group.q.forEach(q => {
                const el = document.querySelector(`input[name="${q.id}"]:checked`);
                if(el) { catSum += parseInt(el.value); catCount++; }
            });
            document.getElementById('badge-'+group.id).innerText = Math.round((catCount / 5) * 100) + "%";
            
            const catAvg = catCount > 0 ? catSum / catCount : 0;
            catAverages.push(catAvg);
            sumGlobal += catSum; totalAnswered += catCount;

            // --- ANIMATION PILLIERS (GRADUELLE : 1/3, 1/2, 100%) ---
            let fillHeight = 0;
            if (catAvg > 0) {
                if (catAvg <= 2) {
                    fillHeight = 33.33 + (catAvg - 1) * 16.67;
                } else {
                    fillHeight = 50 + (catAvg - 2) * 50;
                }
            }
            document.getElementById(`fill-${idx}`).style.height = fillHeight + "%";

            if(catCount > 0) {
                let key = catAvg <= 1.6 ? "debut" : (catAvg <= 2.4 ? "inter" : "expert");
                let label = catAvg <= 1.6 ? "D√âBUTANT" : (catAvg <= 2.4 ? "INTERM√âDIAIRE" : "EXPERT");
                resHtml += `<div class="res-cat-block"><div class="res-cat-header">${group.cat} <span class="res-level-tag">Niveau : ${label}</span></div>`;
                resourcesData[idx][key].forEach(res => { resHtml += `<div class="res-item"><strong>${res.t}</strong><br><a href="${res.l}" target="_blank" rel="noopener noreferrer" onmouseenter="showPreview(event, '${res.t.replace(/'/g, "\\'")}', '${res.d.replace(/'/g, "\\'")}')" onmouseleave="hidePreview()" onfocus="showPreview(event, '${res.t.replace(/'/g, "\\'")}', '${res.d.replace(/'/g, "\\'")}')" onblur="hidePreview()">Consulter</a></div>`; });
                resHtml += `</div>`;
            }
        });

        let globalAvg = totalAnswered > 0 ? (sumGlobal / totalAnswered) : 0;
        currentAvg = globalAvg.toFixed(2);
        
        // --- LIGNE DE MOYENNE GLOBALE (ALIGN√âE SUR LES PILLIERS) ---
        const line = document.getElementById('global-avg-line');
        if(globalAvg > 0) {
            let globalPercent = 0;
            if (globalAvg <= 2) globalPercent = 33.33 + (globalAvg - 1) * 16.67;
            else globalPercent = 50 + (globalAvg - 2) * 50;
            
            line.style.opacity = 1;
            line.style.bottom = (11 + (globalPercent / 100 * 130)) + "px"; 
        } else { line.style.opacity = 0; }

        const sD = document.getElementById('stage-debut'), sI = document.getElementById('stage-inter'), sE = document.getElementById('stage-expert');
        [sD, sI, sE].forEach(s => s.classList.remove('stage-active'));

        let gLvl = "√Ä d√©terminer", gCol = "#888";
        if(globalAvg > 0) {
            if(globalAvg <= 1.6) { gLvl = "D√âBUTANT"; gCol = '#FF8F00'; sD.classList.add('stage-active'); }
            else if(globalAvg <= 2.4) { gLvl = "INTERM√âDIAIRE"; gCol = '#00B0FF'; sD.classList.add('stage-active'); sI.classList.add('stage-active'); }
            else { gLvl = "AVANC√â"; gCol = '#00E676'; sD.classList.add('stage-active'); sI.classList.add('stage-active'); sE.classList.add('stage-active'); }
        }
        
        if(totalAnswered >= 5) {
            document.getElementById('archetype-container').style.display = 'block';
            let cat0 = catAverages[0] || 0, cat1 = catAverages[1] || 0, cat2 = catAverages[2] || 0, cat3 = catAverages[3] || 0;
            let personaKey = (cat0 >= Math.max(cat1, cat2, cat3)) ? "architecte" : (cat3 >= Math.max(cat0, cat1, cat2)) ? "facilitateur" : (cat2 >= Math.max(cat0, cat1, cat3)) ? "explorateur" : "strat√®ge";
            if (globalAvg > 2.3 && (Math.max(...catAverages) - Math.min(...catAverages) < 0.7)) personaKey = "strat√®ge";
            currentPersonaTitle = archetypes[personaKey].t;
            document.getElementById('profile-type-badge').innerText = currentPersonaTitle;
            document.getElementById('profile-description').innerText = archetypes[personaKey].d;
        }

        document.getElementById('gauge-label').innerText = `Moyenne : ${currentAvg} (${gLvl})`;
        document.getElementById('gauge-label').style.color = gCol;
        document.getElementById('completion-tracker').innerText = totalAnswered + " / 20 questions r√©pondues";
        document.getElementById('resList').innerHTML = resHtml || "<p>R√©pondez au questionnaire.</p>";
        autoSaveData();
    }

    function autoSaveData() {
        const data = { name: document.getElementById('user-name').value, answers: {}, notes: {} };
        document.querySelectorAll('input:checked').forEach(i => data.answers[i.name] = i.value);
        for(let i=0; i<4; i++) data.notes[i] = document.getElementById(`notes-${i}`).value;
        try { localStorage.setItem('fad_final_secure', JSON.stringify(data)); } catch(e) { console.warn('LocalStorage failed', e); }
        const cloud = document.getElementById('save-cloud');
        // Use standardized utility classes: is-loading then is-success
        cloud.classList.remove('is-success', 'is-error');
        cloud.classList.add('is-loading');
        const now = new Date();
        const timeStr = now.toLocaleTimeString();
        cloud.title = `Sauvegarde auto : ${timeStr}`;
        // update aria for screen readers
        cloud.setAttribute('aria-label', `Sauvegarde en cours, ${timeStr}`);
        // keep save indicator compact: do not show visible text to avoid menu shift
        const labelEl = cloud.querySelector('.save-label');
        if(labelEl) labelEl.innerText = '';
        // clear previous timeouts if any
        if(cloud._saveTimeout) clearTimeout(cloud._saveTimeout);
        if(cloud._saveTimeout2) clearTimeout(cloud._saveTimeout2);
        cloud._saveTimeout = setTimeout(() => {
            cloud.classList.remove('is-loading');
            cloud.classList.add('is-success');
            // update aria to indicate success (no visible text to avoid layout shift)
            const finishTime = new Date().toLocaleTimeString();
            cloud.setAttribute('aria-label', `Sauvegarde termin√©e √† ${finishTime}`);
            // remove success state after a short delay
            cloud._saveTimeout2 = setTimeout(() => { cloud.classList.remove('is-success'); }, 2200);
        }, 700);
    }

    function saveJSON() {
        const data = JSON.parse(localStorage.getItem('fad_final_secure'));
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type: "application/json"})); a.download = "positionnement.json"; a.click();
    }

    function loadJSON(e) {
        const reader = new FileReader();
        reader.onload = ev => {
            const data = JSON.parse(ev.target.result);
            document.getElementById('user-name').value = data.name || "";
            for(let k in data.answers) { let r = document.querySelector(`input[name="${k}"][value="${data.answers[k]}"]`); if(r) r.checked = true; }
            for(let k in data.notes) if(document.getElementById(`notes-${k}`)) document.getElementById(`notes-${k}`).value = data.notes[k];
            updateProgression();
        };
        reader.readAsText(e.target.files[0]);
    }

    function resetForm() {
        if(confirm("Effacer tout ?")) {
            document.getElementById('user-name').value = "";
            document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
            document.querySelectorAll('.notes-area').forEach(t => t.value = "");
            localStorage.removeItem('fad_final_secure');
            updateProgression();
        }
    }

    window.onload = () => {
        const saved = localStorage.getItem('fad_final_secure');
        if(saved) {
            const data = JSON.parse(saved);
            document.getElementById('user-name').value = data.name || "";
            for(let k in data.answers) { let r = document.querySelector(`input[name="${k}"][value="${data.answers[k]}"]`); if(r) r.checked = true; }
            for(let k in data.notes) if(document.getElementById(`notes-${k}`)) document.getElementById(`notes-${k}`).value = data.notes[k];
            updateProgression();
        }
        // Lancer une sauvegarde automatique toutes les 30 secondes
        if(!window._autoSaveInterval) {
            window._autoSaveInterval = setInterval(() => {
                autoSaveData();
            }, 30000);
        }
    };
</script>

<!-- Axe-core quick runner: append ?axe=1 to the URL to run an accessibility audit in the browser and log results to console -->
<script>
if (location.search.indexOf('axe=1') !== -1) {
    (function(){
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/axe-core/4.8.3/axe.min.js';
        s.onload = () => {
            console.info('axe-core loaded ‚Äî running audit (wcag2a/wcag2aa)...');
            axe.run(document, { runOnly: { type: 'tag', values: ['wcag2a','wcag2aa'] } }, (err, results) => {
                if (err) { console.error('axe error', err); return; }
                console.log('Axe results:', results);
                const critical = results.violations.filter(v => v.impact === 'critical' || v.impact === 'serious');
                if (critical.length) {
                    console.group('Axe critical/serious violations');
                    critical.forEach(v => { console.warn(v.id, v.impact, v.help, v.nodes.length, v.nodes.map(n=>n.target)); });
                    console.groupEnd();
                    alert('Axe audit: ' + critical.length + ' critical/serious violation(s) found ‚Äî check console for details.');
                } else {
                    console.info('Axe: no critical or serious violations found.');
                    alert('Axe audit: no critical/serious violations found.');
                }
            });
        };
        document.head.appendChild(s);
    })();
}
</script>
</body>
</html>
